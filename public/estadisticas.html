<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Casos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #4e73df; }
        body { background-color: #f8f9fc; }
        .card { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
        .navbar-brand { font-weight: 700; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient" style="background-color: var(--primary-color);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-hands-helping me-2"></i>Sistema de Casos - Adultos Mayores
            </a>
            <div class="navbar-nav ms-auto">
                 <a class="nav-link" href="index.html"><i class="fas fa-arrow-left me-1"></i> Volver a la lista</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Modal para detalles -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalTitle">Detalle de Casos</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="detailModalBody">
                        <!-- El contenido de la tabla se generará aquí -->
                    </div>
                </div>
            </div>
        </div>

        <div id="stats-content">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Generador de Gráficos</h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-end g-3">
                        <div class="col-md-2">
                            <label class="form-label small">Estado:</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside" id="statusFilterBtn">Seleccionar...</button>
                                <ul class="dropdown-menu w-100" id="statusFilter"></ul>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Prioridad:</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside" id="priorityFilterBtn">Seleccionar...</button>
                                <ul class="dropdown-menu w-100" id="priorityFilter"></ul>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Sector:</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside" id="sectorFilterBtn">Seleccionar...</button>
                                <ul class="dropdown-menu w-100" id="sectorFilter"></ul>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="fieldSelector" class="form-label small">Dato a graficar:</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="fieldSelectorBtn">
                                    Rango de Edad
                                </button>
                                <ul class="dropdown-menu w-100" id="fieldSelectorList"></ul>
                                <input type="hidden" id="fieldSelectorValue" value="edad">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="chartTypeSelector" class="form-label small">Tipo de gráfico:</label>
                            <select id="chartTypeSelector" class="form-select">
                                <option value="bar">Barras</option>
                                <option value="pie">Torta</option>
                                <option value="doughnut">Anillo</option>
                                <option value="polarArea">Área Polar</option>
                                <option value="line">Líneas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="generateChartBtn" class="btn btn-primary w-100">Generar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-body" style="position: relative; height: 65vh; min-height: 450px;">
                    <canvas id="statsChart" style="cursor: pointer;"></canvas>
                </div>
            </div>
        </div>

        <div id="no-data-message" class="text-center py-5 d-none">
            <div class="card" style="max-width: 600px; margin: auto;">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h3 class="card-title">No hay datos para mostrar</h3>
                    <p class="card-text">Para ver las estadísticas, primero debes cargar un archivo de Excel en la página principal.</p>
                    <a href="index.html" class="btn btn-primary"><i class="fas fa-home me-1"></i> Ir a la página principal</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const casesDataRaw = sessionStorage.getItem('casesDataForStats');
            if (!casesDataRaw) {
                document.getElementById('stats-content').classList.add('d-none');
                document.getElementById('no-data-message').classList.remove('d-none');
                return;
            }

            const allCases = JSON.parse(casesDataRaw);
            let currentChart = null;
            let filteredCases = [];
            const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

            // Estilos globales para Chart.js
            Chart.defaults.font.family = "'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif";
            Chart.defaults.color = '#5a5c69';

            const primaryFields = {
                'Rango de Edad': 'edad',
                'Género': 'genero',
                'Estado del Caso': 'estado',
                'Prioridad': 'prioridad',
                'Sector': 'sector',
                'Casos por Año': 'year',
                'Agrupaciones Vecinales (AV)': 'AV',
                'Antigüedad del Caso (días)': 'caseAge',
            };

            const secondaryFields = {
                'Estado Civil': 'estadoCivil',
                'Nacionalidad': 'nacionalidad',
                'Tenencia de Vivienda': 'vivienda',
            };

            const fieldSelectorBtn = document.getElementById('fieldSelectorBtn');
            const fieldSelectorList = document.getElementById('fieldSelectorList');
            const fieldSelectorValue = document.getElementById('fieldSelectorValue');

            function buildFieldSelector() {
                fieldSelectorList.innerHTML = ''; // Clear list

                // Populate primary fields
                for (const [displayName, value] of Object.entries(primaryFields)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="dropdown-item" href="#" data-value="${value}">${displayName}</a>`;
                    fieldSelectorList.appendChild(li);
                }

                // Add separator and "show more" button
                fieldSelectorList.innerHTML += '<li><hr class="dropdown-divider"></li>';
                const showMoreLi = document.createElement('li');
                showMoreLi.innerHTML = `<a class="dropdown-item" href="#" data-value="show_more">▼ Mostrar más opciones...</a>`;
                showMoreLi.id = 'show-more-option';
                fieldSelectorList.appendChild(showMoreLi);

                // Populate secondary fields but keep them hidden
                for (const [displayName, value] of Object.entries(secondaryFields)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="dropdown-item" href="#" data-value="${value}">${displayName}</a>`;
                    li.classList.add('secondary-field-option', 'd-none'); // Hide with bootstrap class
                    fieldSelectorList.appendChild(li);
                }

                // Add event listeners to all items
                fieldSelectorList.querySelectorAll('a').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const selectedVal = this.dataset.value;
                        const selectedText = this.textContent;

                        if (selectedVal === 'show_more') {
                            e.stopPropagation(); // Prevent dropdown from closing
                            document.getElementById('show-more-option').classList.add('d-none');
                            fieldSelectorList.querySelectorAll('.secondary-field-option').forEach(opt => opt.classList.remove('d-none'));
                        } else {
                            fieldSelectorBtn.textContent = selectedText;
                            fieldSelectorValue.value = selectedVal;
                        }
                    });
                });
            }

            // Initial population
            buildFieldSelector();

            // Añadir un listener para que el menú se reinicie a su estado original cada vez que se abre.
            const fieldSelectorDropdown = document.getElementById('fieldSelectorBtn');
            fieldSelectorDropdown.addEventListener('show.bs.dropdown', () => {
                buildFieldSelector();
            });

            document.getElementById('generateChartBtn').addEventListener('click', generateChart);
            
            // Poblar los filtros
            populateFilter(document.getElementById('statusFilter'), 'estado');
            populateFilter(document.getElementById('priorityFilter'), 'prioridad');
            populateFilter(document.getElementById('sectorFilter'), 'sector');

            function getSelectedFilterValues(ulId) {
                const selected = [];
                document.querySelectorAll(`#${ulId} .form-check-input:checked`).forEach(checkbox => {
                    selected.push(checkbox.value);
                });
                return selected;
            }

            function updateDropdownButtonText(ulId, btnId) {
                const selectedValues = getSelectedFilterValues(ulId);
                const button = document.getElementById(btnId);
                if (selectedValues.length === 0) {
                    button.textContent = 'Seleccionar...';
                } else if (selectedValues.length === 1) {
                    button.textContent = selectedValues[0];
                } else {
                    button.textContent = `${selectedValues.length} seleccionados`;
                }
            }

            function populateFilter(ulElement, fieldKey) {
                const uniqueValues = [...new Set(allCases.map(c => c[fieldKey] || 'No especificado'))].sort();
                ulElement.innerHTML = '';
                uniqueValues.forEach(value => {
                    const li = document.createElement('li');
                    li.className = 'dropdown-item';
                    li.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${value}" id="filter-${fieldKey}-${value.replace(/\s/g, '')}"><label class="form-check-label" for="filter-${fieldKey}-${value.replace(/\s/g, '')}">${value}</label></div>`;
                    li.addEventListener('click', (e) => e.stopPropagation());
                    li.querySelector('input').addEventListener('change', () => updateDropdownButtonText(ulElement.id, ulElement.id + 'Btn'));
                    ulElement.appendChild(li);
                });
            }

            function getAgeInYears(fechaNacimiento) {
                if (!fechaNacimiento) return null;
                let birthDate;
                if (fechaNacimiento instanceof Date) {
                    birthDate = fechaNacimiento;
                } else if (typeof fechaNacimiento === 'number') {
                    birthDate = new Date(Math.round((fechaNacimiento - 25569) * 86400 * 1000));
                } else if (typeof fechaNacimiento === 'string') {
                    const parts = fechaNacimiento.split(/[\/\-]/);
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10);
                        const year = parseInt(parts[2], 10);
                        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                            birthDate = new Date(year, month - 1, day);
                        }
                    }
                }

                if (birthDate && !isNaN(birthDate)) {
                    const today = new Date();
                    let years = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        years--;
                    }
                    return years >= 0 ? years : null;
                }
                return null;
            }

            function getCaseAgeInDays(fechaIngreso) {
                if (!fechaIngreso) return null;
                // Formato esperado: DD-MM-YYYY
                const parts = fechaIngreso.split('-');
                if (parts.length !== 3) return null;

                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);

                if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

                const caseDate = new Date(year, month - 1, day);
                if (isNaN(caseDate.getTime())) return null;

                const today = new Date();
                const diffTime = today.getTime() - caseDate.getTime();
                return Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }

            function processData(cases, fieldKey) {
                const counts = {};
                if (fieldKey === 'edad') {
                    const ageRanges = { '60-69 años': 0, '70-79 años': 0, '80-89 años': 0, '90+ años': 0, 'No especificado': 0 };
                    cases.forEach(caso => {
                        const age = getAgeInYears(caso['FECHA NAC.']);
                        if (age !== null) {
                            if (age >= 60 && age <= 69) ageRanges['60-69 años']++;
                            else if (age >= 70 && age <= 79) ageRanges['70-79 años']++;
                            else if (age >= 80 && age <= 89) ageRanges['80-89 años']++;
                            else if (age >= 90) ageRanges['90+ años']++;
                        } else {
                            ageRanges['No especificado']++;
                        }
                    });
                    return ageRanges;
                }

                if (fieldKey === 'caseAge') {
                    const ageRanges = {
                        '0-30 días': 0,
                        '31-60 días': 0,
                        '61-90 días': 0,
                        '91-180 días': 0,
                        '181+ días': 0,
                        'Fecha inválida': 0
                    };
                    cases.forEach(caso => {
                        const ageDays = getCaseAgeInDays(caso.fechaIngreso);
                        if (ageDays !== null && ageDays >= 0) {
                            if (ageDays <= 30) ageRanges['0-30 días']++;
                            else if (ageDays <= 60) ageRanges['31-60 días']++;
                            else if (ageDays <= 90) ageRanges['61-90 días']++;
                            else if (ageDays <= 180) ageRanges['91-180 días']++;
                            else ageRanges['181+ días']++;
                        } else {
                            ageRanges['Fecha inválida']++;
                        }
                    });
                    return ageRanges;
                }

                if (fieldKey === 'year') {
                    const yearCounts = {};
                    cases.forEach(caso => {
                        if (caso.fechaIngreso && caso.fechaIngreso.length >= 10) {
                            const year = caso.fechaIngreso.split('-')[2];
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        } else {
                            yearCounts['Sin Fecha'] = (yearCounts['Sin Fecha'] || 0) + 1;
                        }
                    });
                    // Ordenar los años para una mejor visualización en el gráfico
                    const sortedYears = Object.keys(yearCounts).sort();
                    const sortedCounts = {};
                    sortedYears.forEach(year => sortedCounts[year] = yearCounts[year]);
                    return sortedCounts;
                }

                cases.forEach(caso => {
                    const value = caso[fieldKey] || 'No especificado';
                    counts[value] = (counts[value] || 0) + 1;
                });
                return counts;
            }

            function generateChart() {
                const selectedStatuses = getSelectedFilterValues('statusFilter');
                const selectedPriorities = getSelectedFilterValues('priorityFilter');
                const selectedSectors = getSelectedFilterValues('sectorFilter');

                filteredCases = allCases.filter(caso => {
                    const status = caso.estado || 'No especificado';
                    const priority = caso.prioridad || 'No especificado';
                    const sector = caso.sector || 'No especificado';

                    const matchesStatus = selectedStatuses.length === 0 || selectedStatuses.includes(status);
                    const matchesPriority = selectedPriorities.length === 0 || selectedPriorities.includes(priority);
                    const matchesSector = selectedSectors.length === 0 || selectedSectors.includes(sector);
                    return matchesStatus && matchesPriority && matchesSector;
                });

                const selectedFieldKey = document.getElementById('fieldSelectorValue').value;
                const selectedFieldText = document.getElementById('fieldSelectorBtn').textContent.trim();
                const selectedChartType = document.getElementById('chartTypeSelector').value;
                const data = processData(filteredCases, selectedFieldKey);

                const labels = Object.keys(data);
                const values = Object.values(data);
                const ctx = document.getElementById('statsChart').getContext('2d');

                if (currentChart) currentChart.destroy();

                // Paleta de colores profesional y consistente
                const professionalColors = [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#fd7e14', '#6f42c1'
                ];

                let datasetOptions = {
                    label: `Distribución por ${selectedFieldText}`,
                    data: values,
                    hoverOffset: 4
                };

                if (selectedChartType === 'bar') {
                    // Colores sólidos con transparencia para las barras
                    datasetOptions.backgroundColor = professionalColors.map(c => c + 'CC'); // ~80% opacidad
                    datasetOptions.borderColor = professionalColors;
                    datasetOptions.borderWidth = 1;
                    // Al pasar el mouse, la barra se vuelve sólida
                    datasetOptions.hoverBackgroundColor = professionalColors;
                    datasetOptions.hoverBorderColor = professionalColors;
                } else {
                    // Para tortas, anillos, etc., usamos colores sólidos con un borde blanco para separación
                    datasetOptions.backgroundColor = professionalColors;
                    datasetOptions.borderColor = '#ffffff';
                    datasetOptions.borderWidth = 2;
                }

                currentChart = new Chart(ctx, {
                    type: selectedChartType,
                    data: {
                        labels: labels,
                        datasets: [datasetOptions]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Clave para controlar la altura
                        plugins: {
                            legend: { 
                                position: (selectedChartType === 'bar' || selectedChartType === 'line') ? 'top' : 'right',
                                labels: { font: { size: 14 } }
                            },
                            title: { 
                                display: true, 
                                text: `Distribución de Casos por ${selectedFieldText}`, 
                                font: { size: 20, weight: '600' },
                                padding: { top: 10, bottom: 30 }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                titleFont: { size: 16, weight: 'bold' },
                                bodyFont: { size: 14 },
                                padding: 12,
                                cornerRadius: 4,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.parsed.y; // Para barras/líneas
                                        if (value === null || value === undefined) {
                                            value = context.parsed; // Para torta/anillo/polar
                                        }
                                        return `${label}: ${value} casos`;
                                    }
                                }
                            }
                        },
                        scales: (selectedChartType === 'bar' || selectedChartType === 'line') ? { 
                            y: {
                                beginAtZero: true, 
                                ticks: { 
                                    color: '#858796',
                                    padding: 10
                                },
                                grid: { 
                                    color: '#e3e6f0', 
                                    drawBorder: false,
                                    borderDash: [2, 4], // Líneas de rejilla discontinuas
                                    zeroLineColor: '#e3e6f0',
                                    zeroLineBorderDash: [2, 4]
                                }
                            },
                            x: {
                                ticks: { color: '#858796', padding: 10 },
                                grid: { display: false } // Sin rejilla vertical
                            }
                        } : {},
                        onClick: (evt, elements) => {
                            if (elements.length === 0) return;
                            const dataIndex = elements[0].index;
                            const clickedLabel = labels[dataIndex];
                            
                            const casesForDetail = filteredCases.filter(caso => {
                                if (selectedFieldKey === 'edad') {
                                    return isAgeInRange(getAgeInYears(caso['FECHA NAC.']), clickedLabel);
                                }
                                if (selectedFieldKey === 'caseAge') {
                                    return isCaseAgeInRange(getCaseAgeInDays(caso.fechaIngreso), clickedLabel);
                                }
                                if (selectedFieldKey === 'year') {
                                    if (clickedLabel === 'Sin Fecha') {
                                        return !caso.fechaIngreso || caso.fechaIngreso.length < 10;
                                    }
                                    return caso.fechaIngreso && caso.fechaIngreso.split('-')[2] === clickedLabel;
                                }
                                return (caso[selectedFieldKey] || 'No especificado') === clickedLabel;
                            });

                            showDetailsInModal(casesForDetail, clickedLabel, selectedFieldText);
                        }
                    }
                });
            }

            function isAgeInRange(age, rangeLabel) {
                if (age === null && rangeLabel === 'No especificado') return true;
                if (age === null) return false;

                switch (rangeLabel) {
                    case '60-69 años': return age >= 60 && age <= 69;
                    case '70-79 años': return age >= 70 && age <= 79;
                    case '80-89 años': return age >= 80 && age <= 89;
                    case '90+ años': return age >= 90;
                    default: return false;
                }
            }

            function isCaseAgeInRange(ageInDays, rangeLabel) {
                if (ageInDays === null && rangeLabel === 'Fecha inválida') return true;
                if (ageInDays === null) return false;

                switch (rangeLabel) {
                    case '0-30 días': return ageInDays <= 30;
                    case '31-60 días': return ageInDays > 30 && ageInDays <= 60;
                    case '61-90 días': return ageInDays > 60 && ageInDays <= 90;
                    case '91-180 días': return ageInDays > 90 && ageInDays <= 180;
                    case '181+ días': return ageInDays > 180;
                    default: return false;
                }
            }

            function showDetailsInModal(cases, category, fieldName) {
                const modalTitle = document.getElementById('detailModalTitle');
                const modalBody = document.getElementById('detailModalBody');

                modalTitle.textContent = `Detalle para: ${fieldName} - ${category} (${cases.length} casos)`;
                
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>RUT</th>
                                    <th>Dirección</th>
                                    <th>Teléfono</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;

                if (cases.length === 0) {
                    tableHtml += '<tr><td colspan="5" class="text-center">No hay casos para mostrar.</td></tr>';
                } else {
                    cases.forEach(caso => {
                        tableHtml += `<tr>
                            <td>${caso.nombre || 'N/A'}</td>
                            <td>${caso.rut || 'N/A'}</td>
                            <td>${caso.direccion || 'N/A'}</td>
                            <td>${caso.telefono || 'N/A'}</td>
                            <td><a href="index.html" class="btn btn-sm btn-outline-primary view-full-details" data-internal-id="${caso.internal_id}">Ver Ficha</a></td>
                        </tr>`;
                    });
                }
                tableHtml += '</tbody></table></div>';
                modalBody.innerHTML = tableHtml;

                // Añadir listeners a los nuevos enlaces para guardar el ID antes de navegar
                modalBody.querySelectorAll('.view-full-details').forEach(link => {
                    link.addEventListener('click', function() {
                        sessionStorage.setItem('showCaseDetailOnLoad', this.dataset.internalId);
                    });
                });

                detailModal.show();
            }

            generateChart();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>