<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurador de Vistas de Expedientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
        }

        .container {
            max-width: 1200px;
        }

        .card {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .column-list {
            min-height: 100px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .column-item {
            cursor: grab;
            padding: 8px;
            margin: 4px 0;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .category-card {
            background-color: #fff;
        }

        .category-highlight {
            border: 2px solid var(--bs-success) !important;
            transition: border 0.5s ease-in-out;
        }

        .drag-handle {
            cursor: move;
            color: #adb5bd;
            margin-right: 10px;
        }

        .drag-handle:hover {
            color: #495057;
        }

        /* Estilo para el botón de colapsar */
        .btn[data-bs-toggle="collapse"] .fa-angle-up {
            transition: transform 0.2s ease-in-out;
        }

        .btn[data-bs-toggle="collapse"][aria-expanded="false"] .fa-angle-up {
            transform: rotate(180deg);
        }

        .dropdown-config-card {
            background-color: #fdfdff;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .drag-handle-option {
            cursor: move;
            color: #adb5bd;
        }

        .drag-handle-option:hover {
            color: #495057;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0"><i class="fas fa-cog me-2"></i>Configurador de Vistas de Expedientes</h2>
            </div>
            <div class="card-body">
                <p class="text-muted">Aquí puedes definir qué campos se mostrarán en la vista de "Detalles" y agruparlos
                    en categorías personalizadas.</p>

                <div class="row mb-4">
                    <div class="col-md-6 border-end">
                        <h5><span class="badge bg-primary rounded-pill me-2">1</span> Iniciar desde Excel</h5>
                        <p class="small text-muted">Usa esta opción si es la primera vez que configuras o si las
                            columnas de tu archivo han cambiado.</p>
                        <div class="input-group">
                            <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
                            <button class="btn btn-primary" id="loadColumnsBtn"><i class="fas fa-sync-alt me-1"></i>
                                Cargar Columnas</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><span class="badge bg-info rounded-pill me-2">Ó</span> Cargar Configuración</h5>
                        <p class="small text-muted">Si ya tienes un archivo <code>expediente_config.json</code>, puedes
                            cargarlo directamente para editarlo.</p>
                        <div class="d-grid">
                            <input type="file" id="importConfigFile" class="d-none" accept=".json">
                            <button class="btn btn-info" id="importConfigBtn" title="Importar configuración"><i
                                    class="fas fa-upload me-1"></i> Importar desde Archivo .json</button>
                        </div>
                    </div>
                </div>

                <div class="text-center my-3">
                    <span class="text-muted">O bien</span>
                </div>

                <div class="row justify-content-center">
                    <div class="col-md-6 d-grid">
                        <button class="btn btn-outline-success" id="loadDefaultConfigBtn"><i
                                class="fas fa-star me-2"></i>Cargar Configuración Predeterminada del Servidor</button>
                        <div class="form-text text-center mt-1">Carga el archivo <code>expediente_config.json</code>
                            guardado en el servidor.</div>
                    </div>
                </div>

                <div id="configSection" class="d-none">
                    <hr class="my-4">
                    <!-- Barra de Acciones Globales -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body bg-light d-flex justify-content-end align-items-center">
                            <p class="text-muted me-auto mb-0 small">Guarda todos los cambios realizados en los pasos 2
                                y 3.</p>
                            <button class="btn btn-primary" id="saveConfigBtn"><i class="fas fa-save me-1"></i> Guardar
                                Configuración</button>
                        </div>
                    </div>

                    <!-- Paso 2 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Paso 2: Organizar columnas</h5>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#step2Collapse" aria-expanded="true" aria-controls="step2Collapse">
                            <i class="fas fa-compress-alt me-1"></i> Ocultar / Mostrar
                        </button>
                    </div>
                    <div class="collapse show" id="step2Collapse">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">Columnas Disponibles</div>
                                    <div class="card-body">
                                        <p class="small text-muted">Arrastra las columnas que quieras mostrar a una
                                            categoría.</p>
                                        <div id="availableColumns" class="column-list"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Categorías de la Vista de Detalles</h5>
                                    <div class="btn-toolbar">
                                        <div class="btn-group btn-group-sm me-2" role="group">
                                            <button class="btn btn-outline-secondary" id="expandAllCategoriesBtn"
                                                title="Expandir Todo"><i class="fas fa-plus-square"></i></button>
                                            <button class="btn btn-outline-secondary" id="collapseAllCategoriesBtn"
                                                title="Contraer Todo"><i class="fas fa-minus-square"></i></button>
                                        </div>
                                        <button class="btn btn-success btn-sm" id="addCategoryBtn"><i
                                                class="fas fa-plus me-1"></i> Nueva Categoría</button>
                                    </div>
                                </div>
                                <p class="small text-muted">Arrastra las categorías por el ícono <i
                                        class="fas fa-grip-vertical"></i> para reordenarlas.</p>
                                <div id="categoriesContainer">
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <!-- Paso 3 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Paso 3: Configurar Listas Desplegables</h5>
                        <p class="small text-muted">Define opciones para que ciertos campos se muestren como listas
                            desplegables en el formulario de edición. Las opciones se guardarán en el archivo de
                            configuración.</p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-warning" id="loadPredefinedListsBtn"><i class="fas fa-magic me-1"></i>
                            Cargar Listas Predefinidas</button>
                        <div class="d-flex align-items-center">
                            <div class="btn-group btn-group-sm me-2" role="group">
                                <button class="btn btn-outline-secondary" id="expandAllDropdownsBtn"
                                    title="Expandir Todo"><i class="fas fa-plus-square"></i></button>
                                <button class="btn btn-outline-secondary" id="collapseAllDropdownsBtn"
                                    title="Contraer Todo"><i class="fas fa-minus-square"></i></button>
                            </div>
                            <div class="input-group" style="max-width: 400px; position: relative; z-index: 10;">
                                <select class="form-select" id="addColumnForDropdown"></select>
                                <button class="btn btn-info" id="addDropdownConfigBtn"><i
                                        class="fas fa-plus me-1"></i>Añadir Campo</button>
                            </div>
                        </div>
                    </div>
                    <div id="dropdownsContainer" class="row">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allHeaders = [];
        let categoryIdCounter = 0; // Contador para garantizar IDs únicos

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loadColumnsBtn').addEventListener('click', loadExcelColumns);
            document.getElementById('loadPredefinedListsBtn').addEventListener('click', loadPredefinedLists);
            document.getElementById('addDropdownConfigBtn').addEventListener('click', addDropdownConfig);

            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                const newCategoryElement = createNewCategory('', [], true);
                if (newCategoryElement) {
                    // Hacemos scroll para que la nueva categoría sea visible y la resaltamos temporalmente.
                    newCategoryElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    newCategoryElement.classList.add('category-highlight');
                    setTimeout(() => {
                        newCategoryElement.classList.remove('category-highlight');
                    }, 2500);
                }
            });
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfiguration);
            document.getElementById('importConfigBtn').addEventListener('click', () => document.getElementById('importConfigFile').click());
            document.getElementById('importConfigFile').addEventListener('change', importConfiguration);
            document.getElementById('loadDefaultConfigBtn').addEventListener('click', loadDefaultConfiguration);

            // Listeners para expandir/contraer todo
            document.getElementById('expandAllCategoriesBtn').addEventListener('click', () => toggleAllCollapses('#categoriesContainer .card-body.collapse', 'show'));
            document.getElementById('collapseAllCategoriesBtn').addEventListener('click', () => toggleAllCollapses('#categoriesContainer .card-body.collapse', 'hide'));
            document.getElementById('expandAllDropdownsBtn').addEventListener('click', () => toggleAllCollapses('#dropdownsContainer .collapse', 'show'));
            document.getElementById('collapseAllDropdownsBtn').addEventListener('click', () => toggleAllCollapses('#dropdownsContainer .collapse', 'hide'));






            const categoriesContainer = document.getElementById('categoriesContainer');
            Sortable.create(categoriesContainer, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: () => {
                    updateCategoryNumbers();
                }
            });

            categoriesContainer.addEventListener('click', (event) => {
                const editButton = event.target.closest('.btn-edit-category');
                if (editButton) {
                    const categoryCard = editButton.closest('.category-card');
                    if (categoryCard) {
                        editCategoryTitle(categoryCard.id);
                    }
                    return;
                }

                const deleteButton = event.target.closest('.btn-delete-category');
                if (deleteButton) {
                    const categoryCard = deleteButton.closest('.category-card');
                    if (categoryCard) {
                        removeCategory(categoryCard.id);
                    }
                    return;
                }
            });

            // Eventos para el contenedor de desplegables
            document.getElementById('dropdownsContainer').addEventListener('click', event => {
                const addOptionBtn = event.target.closest('.btn-add-option');
                if (addOptionBtn) {
                    const card = addOptionBtn.closest('.dropdown-config-card');
                    const input = card.querySelector('.new-option-input');
                    if (input.value.trim()) {
                        addOptionToDropdownUI(card, input.value.trim());
                        input.value = '';
                    }
                }
                const removeConfigBtn = event.target.closest('.btn-remove-dropdown-config');
                if (removeConfigBtn) {
                    removeConfigBtn.closest('.dropdown-config-card').remove();
                }
            });
            loadConfiguration();
        });

        function loadExcelColumns() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecciona un archivo.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Búsqueda más robusta de la fila de encabezados
                const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                let headerRowIndex = -1;
                for (let i = 0; i < sheetData.length; i++) {
                    // Busca una fila que contenga 'ID' y 'NOMBRES' para identificarla como la fila de encabezados
                    const row = sheetData[i].map(String);
                    if (row.includes('ID') && row.includes('NOMBRES')) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    alert('No se pudo encontrar la fila de encabezados. Asegúrese de que el archivo contenga las columnas "ID" y "NOMBRES".');
                    return;
                }

                allHeaders = sheetData[headerRowIndex].filter(h => h && typeof h === 'string' && h.trim() !== '');

                // Al cargar un nuevo archivo, limpiamos la configuración visual anterior para evitar conflictos.
                document.getElementById('categoriesContainer').innerHTML = '';

                displayColumns(allHeaders);
                document.getElementById('configSection').classList.remove('d-none');
                populateDropdownSelector(allHeaders);
            };
            reader.readAsArrayBuffer(file);
        }

        function displayColumns(headers) {
            const container = document.getElementById('availableColumns');
            container.innerHTML = '';
            headers.forEach(header => {
                const div = document.createElement('div');
                div.className = 'column-item';
                div.textContent = header;
                div.dataset.columnName = header;
                container.appendChild(div);
            });
            Sortable.create(container, {
                group: 'shared',
                animation: 150
            });
        }

        function populateDropdownSelector(headers) {
            const select = document.getElementById('addColumnForDropdown');
            select.innerHTML = '<option selected disabled>Selecciona una columna...</option>';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                select.appendChild(option);
            });
        }

        function createNewCategory(name = '', columns = [], prepend = false) {
            const categoryName = name || prompt('Nombre de la nueva categoría:', 'Nueva Categoría ' + (document.querySelectorAll('.category-card').length + 1));
            if (!categoryName) return null;

            // Usar un contador para garantizar que el ID sea siempre único
            const categoryId = 'category-' + categoryIdCounter++;
            const bodyId = 'body-' + categoryId; // ID único para el cuerpo colapsable

            const container = document.getElementById('categoriesContainer');
            const newElement = document.createElement('div');
            newElement.className = 'card category-card mb-3';
            newElement.id = categoryId;

            newElement.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center p-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle" title="Arrastrar para reordenar"></i>
                        <span class="category-number fw-bold me-2"></span>
                        <strong class="category-title">${categoryName}</strong>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#${bodyId}" title="Expandir/Colapsar">
                            <i class="fas fa-angle-up"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-1 btn-edit-category" title="Editar nombre">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-delete-category" title="Eliminar categoría">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body collapse show" id="${bodyId}">
                    <div class="column-list"></div>
                </div>
            `;

            if (prepend) {
                container.prepend(newElement);
            } else {
                container.appendChild(newElement);
            }

            const newList = newElement.querySelector('.column-list');

            columns.forEach(colName => {
                const colItem = findColumnInAvailable(colName);
                if (colItem) {
                    newList.appendChild(colItem);
                }
            });

            Sortable.create(newList, {
                group: 'shared',
                animation: 150
            });

            updateCategoryNumbers();

            return newElement;
        }

        function findColumnInAvailable(colName) {
            const availableContainer = document.getElementById('availableColumns');
            for (let child of availableContainer.children) {
                if (child.dataset.columnName === colName) {
                    return child;
                }
            }
            const div = document.createElement('div');
            div.className = 'column-item';
            div.textContent = colName;
            div.dataset.columnName = colName;
            return div;
        }

        function editCategoryTitle(categoryId) {
            const categoryEl = document.getElementById(categoryId);
            if (!categoryEl) return;

            const titleEl = categoryEl.querySelector('.category-title');
            const currentTitle = titleEl.textContent;
            const newTitle = prompt('Editar nombre de la categoría:', currentTitle);

            if (newTitle && newTitle.trim() !== '' && newTitle !== currentTitle) {
                titleEl.textContent = newTitle;
            }
        }

        function removeCategory(categoryId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría? Las columnas volverán a la lista de disponibles.')) {
                const categoryEl = document.getElementById(categoryId);
                const columns = categoryEl.querySelectorAll('.column-item');
                const availableContainer = document.getElementById('availableColumns');
                columns.forEach(col => availableContainer.appendChild(col));
                categoryEl.remove();
                updateCategoryNumbers();
            }
        }

        function saveConfiguration() {
            const categories = [];
            document.querySelectorAll('#categoriesContainer .category-card').forEach(card => {
                const title = card.querySelector('.category-title').textContent;
                const columns = [];
                card.querySelectorAll('.column-list .column-item').forEach(col => {
                    columns.push(col.dataset.columnName);
                });
                if (columns.length > 0) {
                    categories.push({ title, columns });
                }
            });

            const dropdowns = {};
            document.querySelectorAll('#dropdownsContainer .dropdown-config-card').forEach(card => {
                const columnName = card.dataset.columnName;
                const options = [];
                card.querySelectorAll('.option-text').forEach(opt => {
                    options.push(opt.textContent);
                });
                if (columnName && options.length > 0) {
                    dropdowns[columnName] = options;
                }
            });

            const config = {
                allColumns: allHeaders,
                categories: categories,
                dropdowns: dropdowns
            };

            localStorage.setItem('expedienteConfig', JSON.stringify(config));
            alert('¡Configuración guardada exitosamente!');

            // Inmediatamente después de guardar, se exporta automáticamente.
            exportConfiguration();
        }

        function updateCategoryNumbers() {
            const categoryCards = document.querySelectorAll('#categoriesContainer > .category-card');
            categoryCards.forEach((card, index) => {
                const numberEl = card.querySelector('.category-number');
                if (numberEl) {
                    numberEl.textContent = `${index + 1}.`;
                }
            });
        }

        function exportConfiguration() {
            const configStr = localStorage.getItem('expedienteConfig');
            if (!configStr) {
                alert('No hay configuración guardada para exportar.');
                return;
            }

            const blob = new Blob([configStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'expediente_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const configStr = e.target.result;
                    JSON.parse(configStr); // Validar que es un JSON válido
                    localStorage.setItem('expedienteConfig', configStr);
                    alert('¡Configuración importada exitosamente! La página se recargará para aplicar los cambios.');
                    location.reload(); // Recargar para que loadConfiguration() aplique el nuevo estado
                } catch (error) {
                    alert('Error: El archivo seleccionado no es un archivo de configuración válido.');
                }
            };
            reader.readAsText(file);
        }

        async function loadDefaultConfiguration() {
            if (!confirm('Esto reemplazará tu configuración local actual con la versión guardada en el servidor. ¿Deseas continuar?')) {
                return;
            }
            try {
                // La ruta es relativa a la ubicación de configurador.html
                const response = await fetch('expediente_config.json');
                if (!response.ok) {
                    throw new Error(`No se pudo cargar el archivo: ${response.statusText}`);
                }
                const configStr = await response.text();
                JSON.parse(configStr); // Validar JSON
                localStorage.setItem('expedienteConfig', configStr);
                alert('¡Configuración predeterminada cargada exitosamente! La página se recargará.');
                location.reload();
            } catch (error) {
                alert('Error al cargar la configuración predeterminada: ' + error.message);
            }
        }

        function loadConfiguration() {
            const configStr = localStorage.getItem('expedienteConfig');
            if (configStr) {
                const config = JSON.parse(configStr);
                allHeaders = config.allColumns || [];

                if (allHeaders.length > 0) {
                    // 1. Primero, crea todos los elementos de columna DOM y ponlos en la lista de "Disponibles".
                    //    Esto asegura que tenemos un único elemento por columna para mover.
                    displayColumns(allHeaders);

                    // Rellenar el selector de columnas para el Paso 3.
                    populateDropdownSelector(allHeaders);

                    // 2. Luego, crea las tarjetas de categoría y mueve los elementos de columna correspondientes
                    //    desde "Disponibles" a su categoría.
                    if (config.categories) {
                        config.categories.forEach(cat => {
                            // El 'false' para prepend es importante para que las categorías se carguen en el orden guardado.
                            createNewCategory(cat.title, cat.columns, false);
                        });
                    }

                    // 3. Cargar la configuración de los desplegables
                    if (config.dropdowns) {
                        for (const [columnName, options] of Object.entries(config.dropdowns)) {
                            createDropdownConfigUI(columnName, options);
                        }
                    }

                    updateCategoryNumbers();

                    // 3. Finalmente, muestra toda la sección de configuración.
                    document.getElementById('configSection').classList.remove('d-none');
                }
            }
        }

        function addDropdownConfig() {
            const select = document.getElementById('addColumnForDropdown');
            const columnName = select.value;

            if (!columnName || select.selectedIndex === 0) {
                alert('Por favor, selecciona una columna para configurar.');
                return;
            }

            // Evitar duplicados
            if (document.querySelector(`.dropdown-config-card[data-column-name="${columnName}"]`)) {
                alert(`La configuración para "${columnName}" ya existe.`);
                return;
            }

            createDropdownConfigUI(columnName);
            select.selectedIndex = 0; // Reset select
        }

        function createDropdownConfigUI(columnName, options = []) {
            const container = document.getElementById('dropdownsContainer');
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'col-md-6 col-lg-4 mb-3';

            const cardId = `dropdown-card-${columnName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const collapseId = `collapse-${cardId}`;

            cardWrapper.innerHTML = `
                <div class="card dropdown-config-card h-100" data-column-name="${columnName}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong class="text-primary">${columnName}</strong>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="true" title="Expandir/Colapsar">
                                <i class="fas fa-angle-up"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-remove-dropdown-config" title="Eliminar configuración"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="collapse show" id="${collapseId}">
                        <div class="card-body">
                            <div class="options-list mb-2" style="max-height: 200px; overflow-y: auto;"></div>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control new-option-input" placeholder="Nueva opción">
                                <button class="btn btn-secondary btn-add-option" type="button"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(cardWrapper);

            const cardElement = cardWrapper.querySelector('.card');
            const optionsList = cardElement.querySelector('.options-list');
            Sortable.create(optionsList, {
                handle: '.drag-handle-option',
                animation: 150,
            });
            options.forEach(opt => addOptionToDropdownUI(cardElement, opt));
        }

        function addOptionToDropdownUI(cardElement, optionText) {
            const list = cardElement.querySelector('.options-list');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-grip-vertical drag-handle-option me-2" title="Arrastrar para reordenar"></i>
                    <span class="option-text">${optionText}</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-link text-primary p-0 me-2 btn-edit-option" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn btn-sm btn-link text-danger p-0 btn-remove-option" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;

            optionDiv.querySelector('.btn-remove-option').addEventListener('click', (e) => {
                e.currentTarget.closest('.option-item').remove();
            });

            optionDiv.querySelector('.btn-edit-option').addEventListener('click', (e) => {
                const optionItem = e.currentTarget.closest('.option-item');
                const span = optionItem.querySelector('.option-text');
                const currentText = span.textContent;
                const newText = prompt('Editar opción:', currentText);
                if (newText && newText.trim() !== '' && newText !== currentText) {
                    span.textContent = newText;
                }
            });

            list.appendChild(optionDiv);
        }

        function toggleAllCollapses(selector, action) {
            document.querySelectorAll(selector).forEach(collapseEl => {
                const bsCollapse = bootstrap.Collapse.getInstance(collapseEl) || new bootstrap.Collapse(collapseEl, {
                    toggle: false
                });
                if (action === 'show') {
                    bsCollapse.show();
                } else {
                    bsCollapse.hide();
                }
            });
        }

        function loadPredefinedLists() {
            if (!confirm('Esto agregará una configuración predefinida para muchas columnas. ¿Deseas continuar?')) {
                return;
            }

            const predefinedDropdowns = {
                'SECTOR': ['Norte', 'Sur'],
                'ESTADO': ['Proceso', 'Seguimiento', 'Cerrado', 'Recepcionado'],
                'CRITICIDAD': ['Alta', 'Media', 'Baja'],
                'HABITABILIDAD': ['Recibiendo beneficio', 'No requiere', 'Requiere', 'Cordesan', 'Poligonos', 'Rechaza'],
                'BENEFICIOS': ['Actualmente recibiendo beneficio', 'No requiere', 'Requiere', 'Rechaza', 'Recibió beneficio (indicar periodo)'],
                'CENTRO DE DÍA': ['Actualmente inscrito/a', 'No requiere', 'Requiere', 'Egresó (indicar periodo)', 'Rechaza'],
                'REQUIERE/NO REQUIERE': ['Requiere', 'No Requiere', 'No Aplica'],
                'ELEAM PUBLICO': ['Postulado', 'En proceso', 'No Califica (rechazado por institución)', 'No Aplica'],
                'ELEAM PARTICULAR': ['Recursos insuficientes', 'Ingresó', 'No Aplica'],
                'TRIBUNAL': ['Requiere', 'No Requiere', 'Ingreso por Notificación'],
                'TIPO DE VULNERACIÓN': ['Maltrato fisico', 'Maltrato psicologico', 'Abuso sexual', 'Abuso patrimonial', 'Negligencia', 'Abandono', 'Maltrato estructural'],
                'TRAMITACIÓN': ['Tramitación', 'Seguimiento', 'Sentencia', 'Redacción denuncia', 'Denuncia interpuesta'],
                'TRAMOS RSH': ['Entre el 40% de menores ingresos o mayor vulnerabilidad', 'Entre el 41% al 50% de menores ingresos o mayor vulnerabilidad', 'Entre el 51% al 60% de menores ingresos o mayor vulnerabilidad', 'Entre el 61% al 70% de menores ingresos o mayor vulnerabilidad', 'Entre el 71% al 80% de mayores ingresos o menor vulnerabilidad', 'Entre el 81% al 90% de mayores ingresos o menor vulnerabilidad', 'Entre el 91% al 100% de mayores ingresos o menor vulnerabilidad.'],
                'PREVISIÓN SOCIAL': ['Fonasa A', 'Fonasa B', 'Fonasa C', 'Fonasa D', 'ISAPRE Banmédica S.A.', 'ISAPRE Chuquicamata Ltda.', 'ISAPRE Colmena Golden Cross S.A.', 'ISAPRE Consalud S.A.', 'ISAPRE Cruz Blanca S.A.', 'ISAPRE Cruz del Norte Ltda.', 'ISAPRE Nueva Masvida S.A.', 'ISAPRE Fundación Ltda.', 'ISAPRE Fusat Ltda.', 'ISAPRE Río Blanco Ltda.', 'ISAPRE San Lorenzo Ltda.', 'ISAPRE Vida Tres S.A.', 'Otro', 'No aplica'],
                'ESTABLECIMIENTO DE CONTROL': ['COSAM', 'CESFAM Ignacio Domeyko', 'CESFAM Arauco', 'CESFAM Padre Orellana', 'CESFAM Benjamín Viel', 'EMB Balmaceda', 'EMB Nicola D’Onofrio', 'EMB Concha y Toro', 'EMB Parque Forestal', 'EMB Davila Larrain', 'EMB Gacitua', 'EMB Coquimbo', 'EMB Rojas Jimenez (San Borja)', 'EMB Sargento Aldea', 'EMB San Emilio', 'EMB Carol Urzúa', 'Hospital san Juan de Dios', 'Hospital clinico san Borja Arriaran', 'Hospital de Urgencia de Asistencia Publica', 'Centros privados de salud', 'Consultorio 1', 'Consultorio 5', 'Instituto Geriatrico', 'Instituto Traumatologico', 'Hospital Salvador'],
                'PATOLOGÍAS DE BASE': ['Hipertension alterial', 'Diabetes', 'Dislipidemia (colesterol alto crónico)', 'Insuficiencia cardiaca', 'Enfermedad respiratoria recurente', 'Deterioro cognitivo', 'Obesidad', 'Artrosis', 'Artritis', 'Hiper/hipotiroidismo', 'Desnutricion', 'Otros', 'No aplica', 'Cancer', 'Alzheimer', 'Demencia Senil', 'Parkinson', 'ACV', 'EPOC', 'Ulcera', 'Asma', 'Hernia', 'Cardiopatia', 'Patologia Psiquiatrica'],
                'DETERIORO COGNITIVO': ['Diagnoticado/a', 'Sospecha', 'No aplica', 'Leve', 'Moderada', 'Severa'],
                'NIVEL DE DEPENDENCIA FISICA': ['Leve', 'Moderada', 'Severa', 'No aplica'],
                'AYUDA TECNICA': ['Bastón', 'Andador (burritos)', 'Muletas', 'Silla de ruedas', 'Colchon antiescaras', 'Catre clinico', 'Silla de baño', 'Silla de ducha', 'Audifonos', 'Barras de baño', 'Otros', 'No aplica'],
                'TIPO DE FAMILIA': ['Hogar unipersonal', 'Monoparental', 'Biparental', 'Nuclear', 'Extendido', 'Familia reconstituida'],
                'N° DE HIJOS VIVOS': ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Más de 10'],
                'Cuidadores': ['Hijo', 'Hija', 'Esposo', 'Esposa', 'Hermano', 'Hermana', 'Primo', 'Prima', 'Nieto', 'Nieta', 'Bisnieto', 'Bisnieta', 'Sobrino', 'Sobrina', 'Yerno', 'Nuera', 'Suegro', 'Suegra', 'Padre', 'Madre', 'Vecino/a', 'Amigo/a', 'Cuidador/a particular', 'No aplica', 'Otros Familiares'],
                'Red Secundaria': ['Amigo/a', 'Comedor Solidario', 'Voluntariado', 'Junta de vecinos', 'CAM', 'Club deportivo', 'Centro de Madres', 'Iglesias', 'ONG', 'Fundación', 'Otros', 'No aplica'],
                'Derivación': ['Demanda espontanea', 'Alo Santiago', 'Tribunal de familia', 'SENAMA', 'COSAM', 'CESFAM Ignacio Domeyko', 'CESFAM Padre Orellana', 'CESFAM Benjamín Viel', 'EMB Balmaceda', 'EMB Nicola D’Onofrio', 'EMB Concha y Toro', 'EMB Parque Forestal', 'EMB Davila Larrain', 'EMB Gacitua', 'EMB Coquimbo', 'EMB Rojas Jimenez (San Borja)', 'EMB Sargento Aldea', 'EMB San Emilio', 'EMB Carol Urzúa', 'Club de adulto mayor AM', 'Posta Central', 'Servicios Sociales IMS', 'Alcaldia', 'Otras oficinas IMS', 'Otras Municipalidades', 'Fiscalia', 'Otros', 'Derivación externa', 'CESFAM Arauco'],
                'Recepción': ['Presencial', 'Judicial', 'Memo', 'Correo electrónico', 'Telefonica'],
                'CASOS CERRADOS': ['Fallece', 'Cambio de comuna', 'ingreso Eleam', 'Rechazo de intervención', 'Cambio de situación economica', 'Entrega de beneficios', 'VIF/ Sentencia, seguimiento.', 'Desconoce paradero PM.', 'Cambio situación actual PM', 'Ingreso Clinica familia u otra'],
                'GENERO': ['Masculino', 'Femenino', 'Otro'],
                'Estado Civil': ['Soltero/a', 'Casado/a', 'Divorciado/a', 'Viudo/a', 'Separado de Hecho', 'Conviviente', 'Unión Civil'],
                'ESCOLARIDAD': ['Educación básica incompleta', 'Educación básica completa', 'Educación media incompleta', 'Educación media completa', 'Educación superior incompleta', 'Educación superior completa', 'Analfabetismo absoluto', 'Analfabetismo funcional'],
                'ENTIDAD PAGADORA DE PENSIÓN': ['IPS', 'DIPRECA', 'CAPREDENA', 'AFP Modelo', 'AFP Habitat', 'AFP Cuprum', 'AFP Capital', 'AFP Provida', 'AFP Planvital', 'No aplica', 'Cajas de Compensación', 'Compañias de Seguro', 'Caja de empleados de FF.FF.', 'Caja de empleados del B. Estado'],
                'TIPO DE PENSIÓN': ['Pensiones de Vejez', 'Pensiones de Invalidez', 'Pensión de Sobrevivencia', 'Pension Garantizada Universal', 'Pension basica solidaria de invalidez', 'CAPREDENA - Pension de retiro', 'CAPREDENA - Pension de Montepío', 'DIPRECA - Pension de retiro', 'DIPRECA - Pension de montepío', 'VALECH - Pension de reparación a terceros', 'VALECH - Pension de reparación directa', 'Pensión de gracia', 'No aplica'],
                'APORTE PREVISIONAL/SOLIDARIO/ ASIGNACIÓN/BONOS': ['APS de vejez', 'APS de invalidez', 'CAPREDENA - Asignación familiar', 'CAPREDENA - Asignación por muerte', 'DIPRECA - Asignaciones familiares', 'VALECH - Bono de reparación', 'VALECH - Bonificación Compensatoria', 'Bono por hijo', 'No aplica'],
                'OTROS INGRESOS': ['Empleos', 'Aportes de familiares', 'Aportes de terceros', 'Otros', 'No aplica'],
                'Tramos Ingreso': ['0 - 100.000', '100.001 - 200.000', '200.001- 300.000', '300.001 - 400.000', '400.001 - 500.000', '500.001 - 600.000', '600.001 - 700.000', '700.001 - 800.000', '800.001 - 900.000', '900.001- o Más'],
                'TRAMOS DE EGRESOS': ['0 - 100.000', '100.001 - 200.000', '200.001- 300.000', '300.001 - 400.000', '400.001 - 500.000', '500.001 - 600.000', '600.001 - 700.000', '700.001 - 800.000', '800.001 - 900.000', '900.001- o Más'],
                'TENENCIA VIVIENDA': ['Propietario', 'Adquiriente', 'Allegado', 'Arrendatario', 'Sub-arrendatario', 'Usufructuario', 'Ocupación ilegal'],
                'ESTADO VIVIENDA': ['Deficiente', 'Adecuado', 'Óptimo'],
                'NACIONALIDAD': ['Chilena', 'Haitiana', 'Colombiana', 'Boliviana', 'Peruana', 'Venezolana', 'Ecuatoriana', 'Argentina', 'Afgana', 'Alemana', 'Árabe', 'Australiana', 'Belga', 'Brasilera', 'Camboyana', 'Canadiense', 'China', 'Coreana', 'Costarricense', 'Cubana', 'Danesa', 'Dominicana', 'Egipcia', 'Española', 'Estadounidense', 'Estonia', 'Etiope', 'Filipina', 'Finlandesa', 'Francesa', 'Galesa', 'Griega', 'Guatemalteca', 'Holandesa', 'Hondureña', 'Indonesa', 'Inglesa', 'Irlandesa', 'Israelí', 'Italiana', 'Japonesa', 'Jordana', 'Laosiana', 'Letona', 'Letonesa', 'Malaya', 'Marroquí', 'Mexicana', 'Neocelandesa', 'Nicaragüense', 'Noruega', 'Panameña', 'Paraguaya', 'Polaca', 'Portuguesa', 'Puertorriqueño', 'Rumana', 'Rusa', 'Salvadoreña', 'Sueca', 'Suiza', 'Tailandesa', 'Taiwanesa', 'Turca', 'Ucraniana', 'Uruguaya', 'Vietnamita'],
                'TERRENOS': ['Requiere', 'No Requiere'],
                'TIPO': ['Vehículo Municipal', 'Propios medios', 'Taxi'],
                'Casos': ['Caso nuevo', 'Caso Seguimiento'],
                'RESULTADO': ['Negación a la visita por parte del adulto mayor.', 'Dirección errónea.', 'Persona no se encuentra en el lugar.', 'Cambio de domicilio.', 'Demora por falta de vehículo.', 'Demora por alta demanda.', 'Demora por falta de personal.', 'No realizada. (Otros)', 'Visita realizada']
            };

            for (const [columnName, options] of Object.entries(predefinedDropdowns)) {
                // Evitar duplicados si ya existe una tarjeta para esa columna
                if (!document.querySelector(`.dropdown-config-card[data-column-name="${columnName}"]`)) {
                    createDropdownConfigUI(columnName, options);
                }
            }

            alert('Listas predefinidas cargadas. Recuerda guardar la configuración para que los cambios persistan.');
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>